---
title: "Black Scholes Monte Carlo Simulation Method"
author: "Nikos Matsavelas"
date: "11/7/2019"
output:
  html_document: default
  pdf_document: default
---
## Exercise 2.7 **Papapantoleon Notes** 
We set the function for the Black Scholes Formula 
$$ c = S_{0}e^{-rT}N(d_{1} - K e^{-rT}N(d_{2})) $$
$$ p = K e^{-rT}N(-d_{2})) -S_{0}e^{-rT}N(-d_{1}) $$
$$ d_{1} = \frac{\log(S_{0}/K) + (r+ \sigma^2)T}{\sigma \sqrt{T}}$$
$$ d_{2} = \frac{\log(S_{0}/K) + (r- \sigma^2)T}{\sigma \sqrt{T}}$$

and finally the call price is evaluated by :
$$\mathbb{S}_{0} \times \Phi(d_{1}) - K e^{-rT}\times \Phi (d_{2}) $$
where $\Phi$ is the standard normal distribution value at $d_{1}$ and $d_{2}$. 
```{r }
# 2.7
Call <- function(S0, K, r, Ti, sigma) {
  d1  <-  (log(S0/K) + (r + sigma^2/2)*Ti) / (sigma*sqrt(Ti))
  d2  <-  (log(S0/K) + (r - sigma^2/2)*Ti) / (sigma*sqrt(Ti))
  price = S0 * pnorm(d1)  - K*exp(-r*Ti)*pnorm(d2)
  print(price)}
```
We set the variables in the function:
```{r}
stock   = 100
strike  = 70
risk    = 1
time    = 1/4       
sigma   = 0.02
```
We call the function 

```{r}
Call(stock,strike,risk,time,sigma)
```
Now we write a new function for the Monte Carlo Simulation Method.
Note here that as has been asked the function evaluates the mean,the confidence intervals (lower and upper bound) at $\alpha =0.05$ and $\alpha =0.01$ confidence level and also the convergence rate $1/\sqrt{M}$
```{r}
set.seed(123)
Call.sim  =  function(S0, K, r, Ti, sigma,M) {
  ri      = (r-0.5*sigma^2)*Ti
  sd      = sigma*sqrt(Ti)
  price   = S0*exp(ri+sd*rnorm(M,0,1))
  call    = pmax(0,price - K)
  P.call  = call*(exp(-ri*Ti))
  price.m = mean(P.call)
  lower95 = price.m - qnorm(1-0.05/2) * sd(P.call)/sqrt(M)
  upper95 = price.m + qnorm(1-0.05/2) * sd(P.call)/sqrt(M)
  lower99 = price.m - qnorm(1-0.01/2) * sd(P.call)/sqrt(M) 
  upper99 = price.m + qnorm(1-0.01/2) * sd(P.call)/sqrt(M)
  convrat = 1/sqrt(M)
  c(price.m,lower95,upper95,lower99,upper99,convrat)
}
```
Here we run again the simulation function but we increase the number of iterations to check the estimands and the convergence rate.
```{r}
M = 1000
Call.sim(stock,strike,risk,time,sigma,M)
M = 10000
Call.sim(stock,strike,risk,time,sigma,M)
M = 100000
Call.sim(stock,strike,risk,time,sigma,M)
```



##  Exercise 2.9 **Papapantoleon Notes** 

```{r}
set.seed(123)
MCPrice = function(S0,K,r,Ti,sigma,M){
  t    = 0
  f    = function(S0) max(0, S0 - K)
  h    = function(m) {
  u    = rnorm(m/2)
  tmp  = c(S0 * exp((r - 0.5 * sigma^2) * (Ti - t)
                                   + sigma *sqrt(Ti - t) * u),
           S0 * exp((r-0.5 * sigma^2) * (Ti -t)
                                   + sigma * sqrt(Ti - t) *(-u))) 
    mean(sapply(tmp, function(xx) f(xx)))  }                                                                 
  p = h(M)
  p * exp(-r * (Ti - t))}
```

We call the function 

```{r}
M       = 10000
stock   = 100
strike  = 70
risk    = 1
time    = 1/4       
sigma   = 0.02
MCPrice(stock,strike,risk,time,sigma,M)
```


##  Exercise 2.10 **Papapantoleon Notes**

$$\mathbb{C} = \mathbb{E}(e^{-rT} (\mathbb{S}_{T}- \mathbb{K})_{+})$$
$$\mathbb{P} = \mathbb{E}(e^{-rT} ( \mathbb{K}-\mathbb{S}_{T})_{+})$$
$$\mathbb{C}-\mathbb{P} = \mathbb{E}(e^{-rT} (\mathbb{S}_{T}- \mathbb{K}))=\mathbb{S}_{0}-\mathbb{K}e^{-rT}$$
$$\mathbb{C} = \mathbb{E}(e^{-rT} (\mathbb{K} - (\mathbb{S}_{T})_{+}) + \mathbb{K}))=\mathbb{S}_{0}-\mathbb{K}e^{-rT})) + \mathbb{S}_{0}-\mathbb{K}e^{-rT}$$
```{r}

control = function(S0,K,r,Ti,sigma){
d1    =  (log(S0/K) + (r + sigma^2/2)*Ti) / (sigma*sqrt(Ti))
d2    =  d1 - sigma*sqrt(Ti)
p     =  cbind(S0, K, Ti, sigma,  p = -S0 * pnorm(-d1) + K*exp(-r*Ti)*pnorm(-d2))  
c     =  cbind(S0, K, Ti, sigma,  c =  S0 * pnorm(d1)  - K*exp(-r*Ti)*pnorm(d2)) 
c1 = c[,5] + K*exp(-r*Ti)
p1 = p[,5] + S0 
c(c1,p1,c1-p1)
}
control(stock,strike,risk,time,sigma)
```


As we can see when $K$ increases,the variables:
$\mathbb{C},\mathbb{P}$ increase as well but the difference remain 0.

```{r}
K2=100
control(stock,K2,risk,time,sigma)
K3=150
control(stock,K3,risk,time,sigma)
K4=200
control(stock,K4,risk,time,sigma)
K5=300
control(stock,K5,risk,time,sigma)

```

```{r}

```

